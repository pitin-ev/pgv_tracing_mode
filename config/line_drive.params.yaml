line_drive:
  ros__parameters:
    # =========================
    # Topics (입출력 토픽)
    # =========================
    pose_topic: "/amr11/bcd_pose"   # 입력 PoseStamped 토픽 경로. PGV(R4) 노드가 퍼블리시하는 센서 포즈.
                                  # 좌표계 가정: x=라인 진행 방향(+), y=라인 좌/우 오프셋(+좌측), yaw=라인 대비 각도(rad).
                                  # 센서가 측면 장착이면 아래 sensor_*_offset으로 보정 가능.

    cmd_topic: "/tracing_vel"          # 출력 Twist 토픽. 로봇 로컬 프레임 기준 (x: 전/후, y: 좌/우, z: yaw).

    relative_x_goal_topic: "/line_drive/relative_x_goal"  # (추가) 상대 Δx 목표 입력 토픽명(하드코딩 제거)
    absolute_x_goal_topic: "/line_drive/absolute_x_goal"  # (추가) 절대 x 목표 입력 토픽명(하드코딩 제거)

    go_forward_topic: "/line_drive/go_forward"            # (추가) 수동 전진 hold-to-run 토픽명(하드코딩 제거)
    go_backward_topic: "/line_drive/go_backward"          # (추가) 수동 후진 hold-to-run 토픽명(하드코딩 제거)

    srv_align_name: "/line_drive/align_to_line"           # (추가) yaw 정렬 서비스명(하드코딩 제거)
    srv_nudge_name: "/line_drive/nudge_forward"           # (추가) 마이크로 전진 서비스명(하드코딩 제거)
    srv_align_y_only_name: "/line_drive/align_y_only"     # (추가) 홀로노믹 y-only 정렬 서비스명(하드코딩 제거)

    io_queue_depth: 10                                     # (추가) pubs/subs QoS queue depth. 시스템 부하/네트워크에 따라 튜닝

    nav_command_topic: "amr11/nav_command"  # (추가) NavCommander 토픽명. 기존 코드 하드코딩 제거용(로봇/namespace마다 다름)
    nav_status_topic: "amr11/nav_status"    # (추가) NavStatus 토픽명. 기존 코드 하드코딩 제거용(로봇/namespace마다 다름)

    pose_qos_depth: 5                    # (추가) pose subscriber QoS depth. 네트워크/센서 주기 상황에 따라 튜닝

    # =========================
    # Modes (구동 모드)
    # =========================
    holonomic: true                # true  → 정렬 이후 ω(각속도) 거의 쓰지 않고 vx, vy만 사용 (홀로노믹 플랫폼).
                                  # false → v, ω만 사용(차동/스티어 등 비홀로노믹).
                                  # 현장에서 섞어 쓰려면 false 권장(경로 안정). 완전한 측면 이동 필요시 true.

    # =========================
    # Align & Tolerances (정렬/허용오차)
    # =========================
    yaw_align_threshold_deg: 1.0   # [deg] 초기 정렬 단계 종료 기준. |yaw_err| ≤ 이 값일 때 SLOW_START 진입.
                                  # 너무 작게 잡으면 정렬이 오래 걸림. (권장 1~3deg)

    tolerance_yaw_deg: 3.0         # [deg] 주행 중 허용할 yaw 오차(홀로노믹일 때 미세 보정 임계치).
                                  # 이 값 초과 시 소량의 ω로 미세 보정(최대 ±0.2rad/s 제한). (권장 2~5deg)

    tolerance_xy: 0.006             # [m] 목표 도달 판정에 쓰는 선형 오차. |x_err| ≤ tol AND |y| ≤ tol 이면 도달.
                                  # 너무 작으면 정지 진동(헌팅) 유발 가능. (권장 0.005~0.02m)

    yaw_hysteresis_factor: 1.5     # [-] ALIGN_Y_ONLY에서 yaw 보정 활성/비활성 히스테리시스 외곽 임계 배수.
                    # |yaw_err| > tol_yaw * factor → 보정 ON, |yaw_err| ≤ tol_yaw → OFF.

    yaw_wrap_band_deg: 12.0        # [deg] ±π 경계 부근 sign flip 억제 밴드 폭. | |yaw| - 180° | < band 이면
                    # 측정 yaw 부호를 고정해 진동 감소.

    allow_reverse_heading: true    # true면 ±180° 방향도 라인 진행 방향으로 인정 (reverse 정렬 허용).
                    # 역방향 허용 시 yaw_err 최소 회전 목표(0 vs ±π) 중 더 작은 쪽 사용.

    goto_target_abs_x_list: [10.58, 13.58]  # (추가) MODE_GOTO에서 target_point 인덱스별 목표 x[m] 리스트(기존 하드코딩 제거)
                        # 예: target_point=0 -> 10.58, 1 -> 13.58

    # =========================
    # Control (루프 주기/속도/가속 제한)
    # =========================
    pose_timeout_sec: 0.1          # [s] 포즈 수신 타임아웃. 이 시간 동안 포즈 안 들어오면 비상정지.
                                    # 센서 주기보다 약간 길게 설정(예: 센서 50Hz면 0.2s).

    post_timeout_grace_sec: 1.0    # [s] 타임아웃 후 포즈가 재수신되어도 즉시 재개하지 않고 이 시간만큼 추가 정지.
                    # 센서 회복 직후 튀는 값 / 재정렬 안정 확보용 유예시간.

    grace_log_period_sec: 0.25     # (추가) grace 동안 남은 시간 로그 주기. 운영 시 로그량 조절/디버그 편의

    resume_cancel_goal_distance_m: 1.0  # (추가) grace 종료 후 현재 위치가 목표에 충분히 가까우면 CMD_CANCEL을 보내는 거리 임계값

    control_rate: 50.0             # [Hz] 제어 루프 주기. 센서 주기(예: 50Hz)와 비슷하거나 약간 높게.
                                    # 지나치게 높이면 노이즈 민감, 낮으면 반응 저하.

    max_lin_vel: 0.3               # [m/s] 선속도 상한(홀로노믹: |[vx,vy]|, 비홀로노믹: |v|).
                                    # 로봇 기구 한계/안전 기준으로 설정.

    max_ang_vel: 0.05               # [rad/s] 각속도 상한(정렬/비홀로노믹 주행에 사용).
                                    # 초기 정렬 속도에도 적용되므로 너무 낮게 잡지 않기.

    accel_lin: 0.8                 # [m/s^2] 선가속도 슬루(rate) 제한. 한 주기당 Δv ≤ accel_lin / control_rate.
                                    # 값이 크면 빠르게 가속, 작으면 부드럽지만 느림.

    accel_ang: 1.5                 # [rad/s^2] 각가속도 슬루 제한. 한 주기당 Δω ≤ accel_ang / control_rate.

    # =========================
    # Manual hold-to-run (수동 펄스 주행)
    # =========================
    teleop_speed: 0.15             # [m/s] 수동 전/후진 기본 속도 (hold TRUE 유지 동안 적용).
                    # 너무 크면 급가속/정지 반복 위험, 너무 작으면 응답 둔화.

    manual_timeout: 0.1            # [s] 마지막 TRUE 펄스 이후 유지 시간. 경과 시 자동 비활성.
                    # 짧게 하면 신호를 자주 보내야 하고, 길면 원치 않는 지속 움직임 가능.

    # =========================
    # Slow start (정렬 후 방향성 확인용 미세 전진)
    # =========================
    slow_start_duration: 1.5       # [s] 정렬 직후 +x 방향으로 미세 전진하는 시간.
                                  # “진행 방향 맞는지” 확인 목적. 너무 길면 목표까지 늦어짐. (권장 0.5~1.5s)

    slow_start_speed: 0.0005         # [m/s] 슬로우스타트 속도(+x). 안전하게 아주 작게.

    # =========================
    # Sensor offsets (측면 장착 PGV 보정)
    # =========================
    sensor_yaw_offset_deg: 0.0     # [deg] 센서의 yaw 영점 오차 보정 (라인 기준 + 회전이 +).
                                  # 센서 마운트가 라인 기준 약간 기울면 여기서 보정.

    sensor_x_offset: 0.0           # [m] 센서가 로봇 기준 x축으로 떨어진 거리(+전방, -후방).
                                  # 센서 위치를 로봇 기준으로 환산해 라인 프레임 좌표에 보정 적용.

    sensor_y_offset: 0.0           # [m] 센서가 로봇 기준 y축으로 떨어진 거리(+좌측, -우측).
                                  # 라인 추종 시 y오차 계산에 직접 영향.

    # =========================
    # Gains (P 제어 게인)
    # =========================
    kp_x: 1.0                      # x오차 → 전진/후진 속도 명령 크기.
                                  # 너무 크면 오버슈트/헌팅, 너무 작으면 목표 접근이 느림.

    kp_y: 1.0                      # y오차 → (홀로노믹) vy 또는 (비홀로노믹) ω에 반영(코드상 비홀로노믹은 ω에 가중합).
                                  # 직진 안정성과 횡방향 수렴 속도 트레이드오프.

    kp_yaw: 1.0                    # yaw오차 → ω 명령 크기(정렬 및 비홀로노믹 주행에서 중요).
                                  # 너무 크면 흔들림, 너무 작으면 정렬 지연.

    align_y_only_max_ang_vel: 0.2  # [rad/s] ALIGN_Y_ONLY 단계의 부드러운 yaw 미세 보정 최대 속도 (소프트 클램프 용).
                  # tanh 기반 포화 적용 시 상한. 현재 기본 로직에서는 사용 비활성(주석 처리) 가능.

    # =========================
    # Micro control (목표 도달 후 미세 정렬)
    # =========================
    micro_interval_sec: 0.02       # (추가) 마이크로 제어 시간 스케일. 기존 코드 주석(20ms)과 값 불일치 문제를 파라미터로 해결

    micro_max_delta_xy_m: 0.03     # (추가) 마이크로 XY에서 한 번에 보정하려는 최대 Δx/Δy 제한(안전/안정성)

    micro_xy_initial_speed: 0.0001 # (추가) 마이크로 XY 시작 구간에서 사용하는 아주 작은 시동 속도(하드코딩 제거)
    micro_xy_t_accel_end: 0.3      # (추가) 마이크로 XY 프로파일 구간 경계(가속 종료)
    micro_xy_t_profile_end: 1.3    # (추가) 마이크로 XY 프로파일 구간 경계(프로파일 종료)
    micro_xy_t_settle_end: 1.6     # (추가) 마이크로 XY 정지 안정화 구간 종료

    micro_yaw_max_delta_rad: 0.3   # (추가) 마이크로 Yaw에서 한 번에 회전하려는 최대 Δyaw 제한
    micro_yaw_t_accel_end: 0.3     # (추가) 마이크로 Yaw 프로파일 구간 경계(가속 종료)
    micro_yaw_t_profile_end: 1.0   # (추가) 마이크로 Yaw 프로파일 구간 경계(프로파일 종료)
    micro_yaw_t_settle_end: 1.3    # (추가) 마이크로 Yaw 정지 안정화 구간 종료
    micro_yaw_rotation_radius_m: 0.51 # (추가) v=ω*r에서 r(회전 반경). 센서 위치/기구에 따라 달라 튜닝 필요
